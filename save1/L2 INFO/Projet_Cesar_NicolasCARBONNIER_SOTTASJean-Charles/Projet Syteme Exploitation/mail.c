#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <pthread.h>
#include <stdio.h>
#include <stdlib.h>
#include <dirent.h>

struct mailbox{
	int valeur;
	int bool;
	pthread_cond_t cond;
	pthread_mutex_t mutex;
};
typedef struct mailbox MAILBOX;

struct dat{
	mailbox *mb1;
	mailbox *mb2;
	int mb_it;
};
typedef struct dat data_threads;

void mbox_init (MAILBOX *mb){
	mb->bool=0;
	mb->cond=PTHREAD_COND_INITIALIZER;
	mb->mutex=PTHREAD_MUTEX_INITIALIZER;
}

void nbox_write(MAILBOX *mb,int i){
	pthtead_mutex_lock(&(mb->mutex));
	if((mb->plein)==1)pthread_cond_wait(&(mb->cond),&(mb->mutex));
	(mb->plein)=1;
	(mb->valeur)=i;
	pthtread_cond_signal(&(mb->cond));
	pthread_mutex_unlock(&(mb->mutex));
	
}
int nbox_read(MAILBOX *mb){
	pthtead_mutex_lock(&(mb->mutex));
	if((mb->plein)==0)pthread_cond_wait(&(mb->cond),&(mb->mutex));
	(mb->plein)=0;
	int r = (mb->valeur);
	pthtread_cond_signal(&(mb->cond));
	pthread_mutex_unlock(&(mb->mutex));
	return r;
	
}

void *thread_faux(void *d ){
	data_threads *dt = (data_threads*)d;
	for(int i=0,mb=0;i<dt->mb_it;i++){
		mb=mbox_read(dt->mb1);
		mbox_write(dt->mb2,mb);
	}
	return NULL;

}
int main(){
	
	int mb_threads=atoi(argv[1]);
	int mb_it=atoi(argv[2]);
	pthread_t tid[mb_threads];
	data_threads dt[mb_threads];
	int mb_mailbox=mb_threads + 1;
	mailbox * mb[mb_mailbox];
	for(int i=0;i<mb_mailbox;i++){
		mbox_init(mb+i);
	}
	for(int i=0;i<mb_threads;i++){
		dt[i].mb1=mb+i;
		dt[i].mb2=mb+i+1;
		dt[i].mb_it=mb_it;
		//~ pthread_create()
	}
	exit (0);
}
